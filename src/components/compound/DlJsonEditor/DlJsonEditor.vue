<template>
    <div
        ref="jsonEditorRef"
        class="json-editor"
    />
</template>

<script lang="ts">
import { defineComponent, onMounted, ref, toRefs, watch } from 'vue-demi'
import {
    Content,
    ContentParseError,
    JSONEditor,
    JSONEditorPropsOptional,
    Mode,
    OnChangeStatus,
    TextContent
} from 'vanilla-jsoneditor'
import { debounce } from 'lodash'

export default defineComponent({
    model: {
        prop: 'modelValue',
        event: 'update:model-value'
    },
    props: {
        /**
         * The string to display and modify as JSON
         */
        modelValue: {
            required: false,
            type: String,
            default: '{}'
        },
        indentation: {
            required: false,
            type: Number,
            default: 2
        },
        readonly: {
            required: false,
            type: Boolean,
            default: false
        }
    },
    emits: ['update:model-value', 'align-text', 'change'],
    setup(props, { emit }) {
        const { modelValue, indentation, readonly } = toRefs(props)

        const jsonEditorRef = ref(null)
        const jsonEditor = ref<JSONEditor>(null as any)
        const innerUpdate = ref(false)

        watch(modelValue, (val) => {
            if (innerUpdate.value) {
                innerUpdate.value = false
                return
            }

            jsonEditor.value?.set({
                text: val
            })
        })

        const handleJSONChange = (
            content: Content,
            previousContent: Content,
            status: OnChangeStatus
        ) => {
            if (
                status.contentErrors &&
                (status.contentErrors as ContentParseError).isRepairable !==
                    undefined
            ) {
                if (!(status.contentErrors as ContentParseError).isRepairable) {
                    console.warn('[DlJsonEditor] Failed to parse JSON')
                    return
                }
            }

            if (
                (content as TextContent).text ===
                (previousContent as TextContent).text
            ) {
                return
            }

            innerUpdate.value = true
            emit('update:model-value', (content as TextContent).text)
            emit('change', (content as TextContent).text)
        }

        const debouncedHandleJSONChange = debounce(handleJSONChange, 100)

        const initJsonEditor = () => {
            const initialAttrs: JSONEditorPropsOptional = {
                onChange: debouncedHandleJSONChange,
                indentation: indentation.value,
                mode: Mode.text,
                mainMenuBar: false,
                navigationBar: false,
                statusBar: false
            }

            // There is type instantiation issue with JSONEditor,
            // it gives excessively deep and possibly infinite error
            // @ts-ignore
            jsonEditor.value = new JSONEditor({
                target: jsonEditorRef.value
                    ? (jsonEditorRef.value as Element)
                    : document.createElement('div'),
                props: initialAttrs
            })

            jsonEditor.value?.set({
                text: modelValue.value
            })
        }

        watch(readonly, (val) => {
            jsonEditor.value?.updateProps({
                readOnly: val
            })
        })

        const format = () => {
            try {
                const parsed = JSON.parse(modelValue.value)
                const formatted = JSON.stringify(
                    parsed,
                    null,
                    indentation.value
                )
                jsonEditor.value?.set({
                    text: formatted
                })
            } catch (e) {
                console.warn('[DlJsonEditor] Failed to format document', e)
                return
            }
        }

        onMounted(() => {
            initJsonEditor()
            emit('align-text')
        })

        return {
            jsonEditorRef,
            format
        }
    }
})
</script>

<style lang="scss" scoped>
.json-editor {
    --jse-text-color: var(--dl-color-tooltip-background);
    --jse-delimiter-color: var(--dl-color-tooltip-background);
    --jse-key-color: var(--dl-color-negative);
    --jse-background-color: var(--dl-color-secondary-opaque);
    --jse-value-color-boolean: #ae6307;
    --jse-value-color-string: #337433;
    --jse-panel-background: var(--dl-color-fill);
    --jse-panel-border: var(--dl-color-separator);
    --jse-main-border: 1px solid var(--dl-color-separator);

    height: 100%;
    .jse-error {
        display: none !important;
    }
    .cm-gutters {
        display: none !important;
    }
}
</style>
